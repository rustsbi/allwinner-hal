//! Allwinner D1 ROM runtime.
//!
//! # Usage
//!
//! Here's an sample usage of this crate:
//!
//! ```no_run
//! use allwinner_rt::{entry, Clocks, Peripherals};
//!
//! #[entry]
//! fn main(p: Peripherals, c: Clocks) {
//!     /* code */
//! }
//! ```
#![no_std]

#[macro_use]
mod macros;

mod boot0;
pub use boot0::EgonHead;

#[cfg(any(feature = "nezha", feature = "lichee"))]
mod mctl;
#[cfg(any(feature = "nezha", feature = "lichee"))]
/// Dram initializing function.
pub use mctl::init as dram_init;

pub use allwinner_rt_macros::entry;

pub mod soc {
    pub mod d1;
    pub mod v821;
    pub mod v853;
}

/// Jump over head data to executable code.
///
/// # Safety
///
/// Naked function.
///
/// NOTE: `mxstatus` is a custom T-Head register. Do not confuse with `mstatus`.
/// It allows for configuring special eXtensions. See further below for details.
#[unsafe(naked)]
#[unsafe(link_section = ".text.entry")]
unsafe extern "C" fn start() -> ! {
    const STACK_SIZE: usize = 8 * 1024;
    #[unsafe(link_section = ".bss.uninit")]
    static mut STACK: [u8; STACK_SIZE] = [0; STACK_SIZE];
    core::arch::naked_asm!(
        // Disable interrupt
        "csrw   mie, zero",
        // Enable T-Head ISA extension
        "li     t1, 1 << 22",
        "csrs   0x7C0, t1",
        // Enable T-Head caches
        "li     t0, 0x70013
        csrw    0x7C2, t0
        li      t0, 0x11ff
        csrw    0x7C1, t0
        li      t0, 0x638000
        csrs    0x7C0, t0
        li      t0, 0x16e30c
        csrw    0x7C5, t0",
        // Invalidate instruction and data cache, branch history table
        // and branch target buffer table
        "li     t1, 0x30013",
        "csrs   0x7C2, t1",
        // Prepare programming language stack
        "la     sp, {stack}
        li      t0, {stack_size}
        add     sp, sp, t0",
        // Clear `.bss` section
        "la     t1, sbss
        la      t2, ebss
    3:  bgeu    t1, t2, 3f
        sd      zero, 0(t1)
        addi    t1, t1, 8
        j       3b
    3:  ",
        // Enable floating point unit
        "li     t0, 0x4000",
        "li     t1, 0x2000",
        "csrrc  x0, mstatus, t0",
        "csrrs  x0, mstatus, t1",
        "fscsr  x0",
        // Start Rust main function
        "call   {main}",
        // Platform halt if main function returns
    "3: wfi
        j       3b",
        stack      =   sym STACK,
        stack_size = const STACK_SIZE,
        main       =   sym main,
    )
}

#[rustfmt::skip]
unsafe extern "Rust" {
    // This symbol is generated by `#[entry]` macro in allwinner-rt or other ROM-stage software packages.
    fn main();
}

core::arch::global_asm! {
    ".section .text.head",
    "head_jump:",
    "j  {}",
    sym start,
}

#[cfg(feature = "d1")]
pub use {
    self::soc::d1::{__rom_init_params, Peripherals},
    allwinner_hal::ccu::Clocks,
};
#[cfg(feature = "v821")]
pub use {
    self::soc::v821::{__rom_init_params, Peripherals},
    allwinner_hal::ccu::Clocks,
};

#[cfg(not(any(feature = "d1", feature = "v821")))]
pub struct Peripherals {}
#[cfg(not(any(feature = "d1", feature = "v821")))]
pub struct Clocks {}
#[cfg(not(any(feature = "d1", feature = "v821")))]
#[doc(hidden)]
pub fn __rom_init_params() -> (Peripherals, Clocks) {
    (Peripherals {}, Clocks {})
}
